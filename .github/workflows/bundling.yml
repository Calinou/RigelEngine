name: Bundling

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build_package_linux:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Install dependencies
      run: sudo ./docker/ubuntu-deps.sh
    - name: Run CMake
      run: CC=gcc-8 CXX=g++-8 cmake -H. -Bbuild -DCMAKE_BUILD_TYPE=Release
    - name: Build
      run: cd build && make -j2
    - name: Package (deb)
      run: cd build && cpack -G "DEB" && mv packages/rigelengine.deb packages/rigelengine_linux_x64.deb && mv packages/rigelengine.deb.sha256 packages/rigelengine_linux_x64.deb.sha256
    - name: Run CMake (GL ES version)
      run: CC=gcc-8 CXX=g++-8 cmake -H. -Bbuild -DCMAKE_BUILD_TYPE=Release -DUSE_GL_ES=ON
    - name: Build (GL ES version)
      run: cd build && make -j2
    - name: Package (deb), GL ES version
      run: cd build && cpack -G "DEB" && mv packages/rigelengine.deb packages/rigelengine_linux_gles_x64.deb && mv packages/rigelengine.deb.sha256 packages/rigelengine_linux_gles_x64.deb.sha256
    - uses: actions/upload-artifact@v2
      with:
        name: ubuntu_deb_build
        path: build/packages/*.deb*
  build_package_osx:
    runs-on: macos-10.15
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Install dependencies
      run: brew install boost llvm@8
    - name: Fetch SDL libraries
      run: |
        wget https://libsdl.org/release/SDL2-2.0.14.dmg
        wget https://www.libsdl.org/projects/SDL_mixer/release/SDL2_mixer-2.0.4.dmg
    - name: Install SDL libraries
      run: |
        hdiutil attach SDL2-2.0.14.dmg -quiet -mountpoint /Volumes/SDL2
        hdiutil attach SDL2_mixer-2.0.4.dmg -quiet -mountpoint /Volumes/SDL2_mixer
        mkdir -p ~/Library/Frameworks
        cp -r /Volumes/SDL2/SDL2.framework ~/Library/Frameworks
        cp -r /Volumes/SDL2_mixer/SDL2_mixer.framework ~/Library/Frameworks
    - name: Run CMake
      run: |
        export rigel_llvm_path=`brew --prefix llvm@8`;
        export CC="$rigel_llvm_path/bin/clang";
        export CXX="$CC++";
        export CPPFLAGS="-I$rigel_llvm_path/include";
        export LDFLAGS="-L$rigel_llvm_path/lib -Wl,-rpath,$rigel_llvm_path/lib";
        unset rigel_llvm_path;
        cmake -H. -Bbuild -DCMAKE_BUILD_TYPE=Release
        # TODO: -DCMAKE_OSX_DEPLOYMENT_TARGET=10.14 -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
    - name: Build
      run: cd build && make -j2
    - name: Package (dmg)
      run: cd build && cpack -G "DragNDrop" .. && mv packages/rigelengine.dmg packages/rigelengine_mac_x64.dmg && mv packages/rigelengine.dmg.sha256 packages/rigelengine_mac_x64.dmg.sha256
    - uses: actions/upload-artifact@v2
      with:
        name: macos_dmg_build
        path: build/packages/*.dmg*
